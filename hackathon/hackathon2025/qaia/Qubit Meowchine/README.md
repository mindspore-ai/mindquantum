# 基于多阶段“量子启发式+机器学习”框架的波束赋形优化

## 1. 项目简介

本项目提供了一个用于天线阵列波束赋形的优化解决方案。它采用了一个**多阶段混合优化框架**，结合了**量子启发算法 (LQA)** 进行相位参数的离散优化，以及**经典机器学习算法 (Adam 优化器)** 进行幅度参数的连续优化。旨在有效提升天线阵列在特定方向的信号强度（主瓣增强），同时抑制非期望方向的信号（旁瓣抑制）。

## 2. 核心功能

* **天线阵列建模**: 模拟 N=32 个阵元的等间距线性天线阵列。
* **主瓣增强与旁瓣抑制**: 核心优化目标，通过调整阵元相位和幅度实现。
* **QUBO 问题转化**: 将波束赋形优化问题（包含主瓣增强和旁瓣抑制）转化为二次无约束二进制优化 (QUBO) 形式。
* **量子启发相位优化**: 利用 MindQuantum 平台提供的 LQA (Local Quantum Annealing) 算法对 QUBO 问题进行求解，以获得最优的阵元相位编码。
* **机器学习幅度优化**: 可选地，使用 PyTorch 框架中的 Adam 优化器对阵元幅度进行梯度下降优化，进一步精细调整波束方向图。
* **多比特编码支持**: 支持不同比特数的相位编码（例如 1、2、3、4 比特），将二进制 QUBO 解码为对应的复数相位值。
* **波束图可视化**: 绘制并保存优化后的天线阵列波束方向图。

## 3. 优化流程详解

本项目的优化流程主要由 `BF` 类中的 `solve()` 方法协调，可分为以下阶段：

### 3.1 初始化与建模

* **参数配置**: 定义波束中心角度 (`theta_0`)、阵元数 (`N`)、编码比特数 (`encode_qubit`)、主瓣与旁瓣优化的权重 (`weight`)、旁瓣压制区间等关键参数。
* **场数据生成**: 根据设定的天线阵列模型，计算天线单元方向图 (`EF`) 和阵列因子 (`AF`)，并组合生成电场分布张量 (`self.efield`)。
* **幅度初始化**: 所有阵元的幅度默认初始化为 1。

### 3.2 相位优化 (基于 QUBO 和 LQA)

这一阶段旨在确定每个阵元的最佳相位：

1.  **QUBO 矩阵构建**:
    * 通过复加权系数 (`c1`, `c2`)，将主瓣增强 (`J_enhance`) 和旁瓣抑制 (`J_suppress`) 的目标统一起来。
    * `J_enhance` 旨在最大化目标方向的能量，`J_suppress` 则旨在最小化旁瓣区域的能量。
    * 根据预设的 `weight` 参数，将 `J_enhance` 和 `J_suppress` 加权组合，形成最终的 QUBO 矩阵 `J`，该矩阵封装了多目标的优化问题。
2.  **LQA 求解**: 利用 `mindquantum.algorithm.qaia.LQA` 求解器对构建的 `J` 矩阵进行优化，得到一组二进制比特解 (`x_best`)，代表了最优的相位编码状态。
3.  **相位解码**: `encode()` 方法将 `x_best`（二进制比特串）解码为实际的复数相位值，进而提取出相位角 (`self.phase_angle`)。解码逻辑根据 `encode_qubit` 的不同值（1、2、3、4比特）采用不同的映射方式。


### 3.3 幅度优化 (可选，基于 Adam 优化器)

如果 `opt_amp_or_not` 参数设置为 `True`，则在相位优化完成后执行此阶段：

1.  **成本函数定义**: 定义一个损失函数 `cost_func_for_amp`，用于衡量当前幅度和已优化相位下的波束性能。该函数旨在最小化旁瓣能量与主瓣能量比值的立方 (`loss_1^3 / (loss_2 + 1e-8)`)，从而实现旁瓣的深度抑制同时保持主瓣增益。
2.  **Adam 优化**: 使用 PyTorch 的 `torch.optim.Adam` 优化器对幅度进行迭代更新，通过梯度下降方式不断调整幅度值，以最小化定义的成本函数。

### 3.4 结果输出与可视化

* **幅度归一化**: 最终的幅度值会被归一化，使其最大值不超过 1。
* **结果打印**: 打印出优化后的相位角和幅度值。
* **波束图绘制**: 绘制优化后的波束方向图，并将其保存为 JPG 图像文件 (`[theta_0]_beamforming.jpg`)。

## 4. 环境要求

* Python 3.9
* `numpy`
* `torch`
* `matplotlib`
* `tqdm`
* `mindquantum`

## 5. 安装与使用

### 5.1 安装依赖

```bash
pip install numpy torch matplotlib tqdm mindquantum
```

### 5.2 运行代码

直接运行 `codes.py` 文件，可以通过修改 `if __name__ == "__main__":` 下的 `optimized()` 函数参数来控制优化行为。

```python
# 在 codes.py 文件的最下方
if __name__ == "__main__":
    # 调用 optimized 函数，参数依次为：
    # [目标主瓣角度, 编码比特数, 是否启用幅度优化(True/False)]
    result = optimized([112, 2, False]) # 示例：目标主瓣112度，2比特编码，不启用幅度优化
```

**参数说明**:

  * `variables[0]`: `theta_0` (目标主瓣角度，单位：度)。
  * `variables[1]`: `encode_qubit` (相位编码比特数，支持 1, 2, 3, 4)。
  * `variables[2]`: `opt_amp_or_not` (布尔值，是否启用幅度优化)。

### 5.3 结果查看

程序运行完成后，会在当前目录下生成一个名为 `[theta_0]_beamforming.jpg` 的图片文件，展示优化后的波束方向图。同时，控制台会打印出最终的相位角和幅度值。

## 6\. 代码结构

  * `optimized(variables)`: 主入口函数，负责初始化 `BF` 对象并启动优化流程。
  * `cosd_f(x)` / `sind_f(x)`: 辅助函数，用于计算以度为单位的余弦和正弦。
  * `BF` 类: 波束赋形的核心类。
      * `__init__(self, param)`: 构造函数，初始化参数、场数据和幅度。
      * `solve(self)`: 协调整个优化流程，包括相位和幅度优化。
      * `opt_phase_QUBO(self)`: 实现 QUBO 矩阵构建和 LQA 求解相位。
      * `opt_amp(self, amp, phase_angle)`: 实现基于 Adam 优化器的幅度优化。
      * `encode(self, x_bit)`: 将二进制比特串解码为复数相位值。
      * `plot(self)`: 绘制并保存波束方向图。
      * `_generate_power_pattern(self)`: 生成单元方向图。
      * `_generate_array_factor(self)`: 生成阵列因子。
      * `_get_index(self, angle_value)`: 辅助函数，将角度映射到数组索引。
